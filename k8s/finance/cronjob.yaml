---
apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: config-map-creator
  namespace: finance
spec:
  schedule: "* * * * *"
  concurrencyPolicy: Forbid
  failedJobsHistoryLimit: 1
  successfulJobsHistoryLimit: 1
  jobTemplate:
    metadata:
      labels:
        cronjob: config-map-creator
    spec:
      template:
        metadata:
          annotations:
            vault.hashicorp.com/agent-inject: "true"
            vault.hashicorp.com/role: "finance"
            vault.hashicorp.com/agent-pre-populate-only: "true"
            vault.hashicorp.com/agent-inject-secret-configmap.yaml: "secret/finance/main"
            vault.hashicorp.com/agent-inject-template-configmap.yaml: |
              {{- with secret "secret/finance/main" -}}
              {{- .Data.text -}}
              {{- end -}}
        spec:
          restartPolicy: Never
          serviceAccount: config-map-creator
          containers:
          - name: create-config-map
            image: gcr.io/google_containers/hyperkube:v1.15.5
            command:
            - /bin/sh
            - -c
            - |-
              kubectl apply -f /vault/secrets/configmap.yaml
