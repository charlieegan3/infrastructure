---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: instagram-archive-refresh
  namespace: instagram-archive
  annotations:
    iam.gke.io/gcp-service-account: cronjob@tidal-eon-199618.iam.gserviceaccount.com
---
apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: instagram-archive-refresh
  namespace: instagram-archive
spec:
  # this is to prevent the controller hitting FailedNeedsStart
  # I think this is related to clock skew from my premptible VMs
  startingDeadlineSeconds: 30
  successfulJobsHistoryLimit: 1
  concurrencyPolicy: Forbid
  schedule: "0 0,12,18 * * *"
  jobTemplate:
    metadata:
      labels:
        cronjob: instagram-archive-refresh
    spec:
      template:
        spec:
          serviceAccount: instagram-archive-refresh
          restartPolicy: Never
          volumes:
          - name: secrets
            emptyDir:
              medium: Memory
          - name: vault-token
            emptyDir:
              medium: Memory
          - name: consul-template-config
            configMap:
              name: consul-template
          - name: google-application-credentials
            secret:
              secretName: google-application-credentials
          initContainers:
          - name: vault-authenticator
            image: registry.hub.docker.com/sethvargo/vault-kubernetes-authenticator:0.1.0
            volumeMounts:
            - name: vault-token
              mountPath: /home/vault
            env:
            - name: TOKEN_DEST_PATH
              value: /home/vault/.vault-token
            - name: VAULT_ADDR
              value: "http://vs-vault.vault:8200"
            - name: VAULT_ROLE
              value: instagram-archive
          - name: consul-template
            image: registry.hub.docker.com/hashicorp/consul-template:0.19.5-scratch
            command:
            - /consul-template
            - -config
            - /etc/consul-template/config.hcl
            - -log-level
            - debug
            - -once
            volumeMounts:
            - name: secrets
              mountPath: /etc/config
            - name: vault-token
              mountPath: /home/vault
            - name: consul-template-config
              mountPath: /etc/consul-template
            env:
            - name: HOME
              value: /home/vault
            - name: VAULT_ADDR
              value: "http://vs-vault.vault:8200"
            - name: VAULT_SKIP_VERIFY
              value: "true"
          containers:
          - name: instagram-archive-refresh
            image: charlieegan3/photos:45eba7a398d04b1db7ed368a465fbfbd0dc8e68d
            resources:
              requests:
                cpu: 10m
                memory: 10Mi
              limits:
                cpu: 0.5
                memory: 500Mi
            command:
            - sh
            - -c
            - |
              gcloud auth activate-service-account --key-file=/etc/config/google/key.json && \
              /entrypoint.sh
            volumeMounts:
            - name: secrets
              mountPath: /etc/config
            - name: google-application-credentials
              mountPath: /etc/config/google
